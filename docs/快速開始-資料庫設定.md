# 🚀 快速開始 - 資料庫設定指引

## 📋 總覽

本指引幫助您快速建立完整的資料庫架構，包含：
- ✅ 現有表格：`places`, `hours`, `accommodations`
- 🆕 會員系統：8 張新表

## 🔧 前置需求

確保以下服務已啟動：

```bash
# 1. 啟動 PostgreSQL 資料庫
docker-compose up -d db

# 2. 檢查資料庫連線
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "\dt"
```

## 📦 執行 Migration

### 方法 1: 一鍵執行（推薦）

```bash
# 執行會員系統 Migration
python3 scripts/run_migration.py 001_create_user_system_tables
```

### 方法 2: 手動執行 SQL

```bash
# 直接執行 SQL 檔案
psql postgresql://postgres:password@localhost:5432/itinerary_db \
  -f scripts/migrations/001_create_user_system_tables.sql
```

## ✅ 驗證結果

### 檢查表格是否已建立

```bash
# 使用 psql
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "
SELECT tablename 
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;
"
```

應該看到以下表格：

```
✅ 現有表格（3張）:
   - accommodations
   - hours
   - places

🆕 新建表格（8張）:
   - conversation_sessions
   - feedback_events
   - place_favorites
   - trip_days
   - trip_visits
   - user_preferences
   - user_trips
   - users
```

### 檢查 ORM 模型

```bash
# 測試 ORM 模型是否正確載入
python3 -c "
from src.itinerary_planner.infrastructure.persistence.orm_models import (
    User, UserPreference, UserTrip, TripDay, TripVisit, 
    PlaceFavorite, ConversationSession, FeedbackEvent
)
print('✅ 所有 ORM 模型載入成功！')
print(f'   - User: {User.__tablename__}')
print(f'   - UserTrip: {UserTrip.__tablename__}')
print(f'   - PlaceFavorite: {PlaceFavorite.__tablename__}')
"
```

## 📊 資料庫架構總覽

### ER 關係圖（簡化版）

```
users (使用者)
  ├─→ user_preferences (1:1)
  ├─→ user_trips (1:N)
  │     ├─→ trip_days (1:N)
  │     │     ├─→ trip_visits (1:N)
  │     │     │     └─→ places (N:1)
  │     │     └─→ accommodations (N:1)
  │     └─→ feedback_events (1:N)
  ├─→ place_favorites (1:N)
  │     └─→ places (N:1)
  └─→ conversation_sessions (1:N)

places (景點)
  └─→ hours (1:N)
```

### 資料表說明

| 表格名稱 | 說明 | 主要欄位 |
|---------|------|---------|
| `users` | 使用者帳號 | email, username, password_hash, provider |
| `user_preferences` | 使用者偏好 | favorite_themes, travel_pace, budget_level |
| `user_trips` | 會員行程 | title, destination, itinerary_data, is_public |
| `trip_days` | 行程天數 | day_number, date, accommodation_id |
| `trip_visits` | 景點訪問 | place_id, eta, etd, travel_minutes |
| `place_favorites` | 景點收藏 | user_id, place_id |
| `conversation_sessions` | 對話 Session | session_id, state_data, expires_at |
| `feedback_events` | 回饋記錄 | op, reason, feedback_text |

## 🔍 常用查詢

### 查看資料表數量

```sql
SELECT 
    schemaname,
    COUNT(*) as table_count
FROM pg_tables 
WHERE schemaname = 'public'
GROUP BY schemaname;
```

### 查看資料表大小

```sql
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
```

### 查看外鍵關聯

```sql
SELECT
    tc.table_name AS 來源表格,
    kcu.column_name AS 來源欄位,
    ccu.table_name AS 參考表格,
    ccu.column_name AS 參考欄位
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
ORDER BY tc.table_name;
```

## 🧪 測試資料

### 建立測試使用者

```sql
-- 插入測試使用者
INSERT INTO users (email, username, password_hash, provider, is_verified)
VALUES 
    ('test@example.com', 'test_user', '$2b$12$...', 'email', TRUE)
RETURNING id, email, username;

-- 建立使用者偏好
INSERT INTO user_preferences (user_id, favorite_themes, travel_pace, budget_level)
SELECT id, ARRAY['美食', '自然'], 'moderate', 'moderate'
FROM users WHERE email = 'test@example.com';
```

### 建立測試行程

```sql
-- 插入測試行程
INSERT INTO user_trips (
    user_id, 
    title, 
    destination, 
    duration_days, 
    start_date, 
    end_date,
    itinerary_data
)
SELECT 
    id,
    '宜蘭兩日遊',
    '宜蘭',
    2,
    '2025-10-01',
    '2025-10-02',
    '{"days": []}'::jsonb
FROM users WHERE email = 'test@example.com'
RETURNING id, title, destination;
```

## 🔄 Rollback（回滾）

如果需要刪除所有會員系統表格：

```sql
-- ⚠️ 警告：此操作會刪除所有會員相關資料
BEGIN;

DROP TABLE IF EXISTS feedback_events CASCADE;
DROP TABLE IF EXISTS conversation_sessions CASCADE;
DROP TABLE IF EXISTS place_favorites CASCADE;
DROP TABLE IF EXISTS trip_visits CASCADE;
DROP TABLE IF EXISTS trip_days CASCADE;
DROP TABLE IF EXISTS user_trips CASCADE;
DROP TABLE IF EXISTS user_preferences CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;

COMMIT;
```

## 📚 下一步

資料庫設定完成後，您可以：

1. ✅ 開始實作認證 API
   ```bash
   # 建立認證服務
   mkdir -p src/itinerary_planner/application/services
   touch src/itinerary_planner/application/services/auth_service.py
   ```

2. ✅ 建立資料庫 Repository
   ```bash
   # 建立使用者 Repository
   touch src/itinerary_planner/infrastructure/repositories/user_repository.py
   ```

3. ✅ 編寫 API 端點
   ```bash
   # 建立認證 API
   touch src/itinerary_planner/api/v1/endpoints/auth.py
   ```

## 🐛 常見問題

### Q1: Migration 執行失敗怎麼辦？

```bash
# 檢查資料庫連線
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "SELECT version();"

# 檢查表格是否已存在
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "\dt"

# 如果需要重新執行，先刪除表格（參考 Rollback 部分）
```

### Q2: ORM 模型載入失敗

```bash
# 檢查 Python 路徑
python3 -c "import sys; print('\n'.join(sys.path))"

# 重新安裝依賴
pip install -r requirements.txt
```

### Q3: 外鍵約束錯誤

確保依照順序插入資料：
1. users → user_preferences
2. places → place_favorites
3. user_trips → trip_days → trip_visits

## 📞 參考資料

- [系統架構設計文件](./系統架構設計文件.md)
- [Migration README](../scripts/migrations/README.md)
- [TODO 清單](../TODO.md)
