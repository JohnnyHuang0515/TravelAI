# ğŸš€ å¿«é€Ÿé–‹å§‹ - è³‡æ–™åº«è¨­å®šæŒ‡å¼•

## ğŸ“‹ ç¸½è¦½

æœ¬æŒ‡å¼•å¹«åŠ©æ‚¨å¿«é€Ÿå»ºç«‹å®Œæ•´çš„è³‡æ–™åº«æ¶æ§‹ï¼ŒåŒ…å«ï¼š
- âœ… ç¾æœ‰è¡¨æ ¼ï¼š`places`, `hours`, `accommodations`
- ğŸ†• æœƒå“¡ç³»çµ±ï¼š8 å¼µæ–°è¡¨

## ğŸ”§ å‰ç½®éœ€æ±‚

ç¢ºä¿ä»¥ä¸‹æœå‹™å·²å•Ÿå‹•ï¼š

```bash
# 1. å•Ÿå‹• PostgreSQL è³‡æ–™åº«
docker-compose up -d db

# 2. æª¢æŸ¥è³‡æ–™åº«é€£ç·š
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "\dt"
```

## ğŸ“¦ åŸ·è¡Œ Migration

### æ–¹æ³• 1: ä¸€éµåŸ·è¡Œï¼ˆæ¨è–¦ï¼‰

```bash
# åŸ·è¡Œæœƒå“¡ç³»çµ± Migration
python3 scripts/run_migration.py 001_create_user_system_tables
```

### æ–¹æ³• 2: æ‰‹å‹•åŸ·è¡Œ SQL

```bash
# ç›´æ¥åŸ·è¡Œ SQL æª”æ¡ˆ
psql postgresql://postgres:password@localhost:5432/itinerary_db \
  -f scripts/migrations/001_create_user_system_tables.sql
```

## âœ… é©—è­‰çµæœ

### æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å·²å»ºç«‹

```bash
# ä½¿ç”¨ psql
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "
SELECT tablename 
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;
"
```

æ‡‰è©²çœ‹åˆ°ä»¥ä¸‹è¡¨æ ¼ï¼š

```
âœ… ç¾æœ‰è¡¨æ ¼ï¼ˆ3å¼µï¼‰:
   - accommodations
   - hours
   - places

ğŸ†• æ–°å»ºè¡¨æ ¼ï¼ˆ8å¼µï¼‰:
   - conversation_sessions
   - feedback_events
   - place_favorites
   - trip_days
   - trip_visits
   - user_preferences
   - user_trips
   - users
```

### æª¢æŸ¥ ORM æ¨¡å‹

```bash
# æ¸¬è©¦ ORM æ¨¡å‹æ˜¯å¦æ­£ç¢ºè¼‰å…¥
python3 -c "
from src.itinerary_planner.infrastructure.persistence.orm_models import (
    User, UserPreference, UserTrip, TripDay, TripVisit, 
    PlaceFavorite, ConversationSession, FeedbackEvent
)
print('âœ… æ‰€æœ‰ ORM æ¨¡å‹è¼‰å…¥æˆåŠŸï¼')
print(f'   - User: {User.__tablename__}')
print(f'   - UserTrip: {UserTrip.__tablename__}')
print(f'   - PlaceFavorite: {PlaceFavorite.__tablename__}')
"
```

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹ç¸½è¦½

### ER é—œä¿‚åœ–ï¼ˆç°¡åŒ–ç‰ˆï¼‰

```
users (ä½¿ç”¨è€…)
  â”œâ”€â†’ user_preferences (1:1)
  â”œâ”€â†’ user_trips (1:N)
  â”‚     â”œâ”€â†’ trip_days (1:N)
  â”‚     â”‚     â”œâ”€â†’ trip_visits (1:N)
  â”‚     â”‚     â”‚     â””â”€â†’ places (N:1)
  â”‚     â”‚     â””â”€â†’ accommodations (N:1)
  â”‚     â””â”€â†’ feedback_events (1:N)
  â”œâ”€â†’ place_favorites (1:N)
  â”‚     â””â”€â†’ places (N:1)
  â””â”€â†’ conversation_sessions (1:N)

places (æ™¯é»)
  â””â”€â†’ hours (1:N)
```

### è³‡æ–™è¡¨èªªæ˜

| è¡¨æ ¼åç¨± | èªªæ˜ | ä¸»è¦æ¬„ä½ |
|---------|------|---------|
| `users` | ä½¿ç”¨è€…å¸³è™Ÿ | email, username, password_hash, provider |
| `user_preferences` | ä½¿ç”¨è€…åå¥½ | favorite_themes, travel_pace, budget_level |
| `user_trips` | æœƒå“¡è¡Œç¨‹ | title, destination, itinerary_data, is_public |
| `trip_days` | è¡Œç¨‹å¤©æ•¸ | day_number, date, accommodation_id |
| `trip_visits` | æ™¯é»è¨ªå• | place_id, eta, etd, travel_minutes |
| `place_favorites` | æ™¯é»æ”¶è— | user_id, place_id |
| `conversation_sessions` | å°è©± Session | session_id, state_data, expires_at |
| `feedback_events` | å›é¥‹è¨˜éŒ„ | op, reason, feedback_text |

## ğŸ” å¸¸ç”¨æŸ¥è©¢

### æŸ¥çœ‹è³‡æ–™è¡¨æ•¸é‡

```sql
SELECT 
    schemaname,
    COUNT(*) as table_count
FROM pg_tables 
WHERE schemaname = 'public'
GROUP BY schemaname;
```

### æŸ¥çœ‹è³‡æ–™è¡¨å¤§å°

```sql
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
```

### æŸ¥çœ‹å¤–éµé—œè¯

```sql
SELECT
    tc.table_name AS ä¾†æºè¡¨æ ¼,
    kcu.column_name AS ä¾†æºæ¬„ä½,
    ccu.table_name AS åƒè€ƒè¡¨æ ¼,
    ccu.column_name AS åƒè€ƒæ¬„ä½
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
ORDER BY tc.table_name;
```

## ğŸ§ª æ¸¬è©¦è³‡æ–™

### å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…

```sql
-- æ’å…¥æ¸¬è©¦ä½¿ç”¨è€…
INSERT INTO users (email, username, password_hash, provider, is_verified)
VALUES 
    ('test@example.com', 'test_user', '$2b$12$...', 'email', TRUE)
RETURNING id, email, username;

-- å»ºç«‹ä½¿ç”¨è€…åå¥½
INSERT INTO user_preferences (user_id, favorite_themes, travel_pace, budget_level)
SELECT id, ARRAY['ç¾é£Ÿ', 'è‡ªç„¶'], 'moderate', 'moderate'
FROM users WHERE email = 'test@example.com';
```

### å»ºç«‹æ¸¬è©¦è¡Œç¨‹

```sql
-- æ’å…¥æ¸¬è©¦è¡Œç¨‹
INSERT INTO user_trips (
    user_id, 
    title, 
    destination, 
    duration_days, 
    start_date, 
    end_date,
    itinerary_data
)
SELECT 
    id,
    'å®œè˜­å…©æ—¥éŠ',
    'å®œè˜­',
    2,
    '2025-10-01',
    '2025-10-02',
    '{"days": []}'::jsonb
FROM users WHERE email = 'test@example.com'
RETURNING id, title, destination;
```

## ğŸ”„ Rollbackï¼ˆå›æ»¾ï¼‰

å¦‚æœéœ€è¦åˆªé™¤æ‰€æœ‰æœƒå“¡ç³»çµ±è¡¨æ ¼ï¼š

```sql
-- âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œæœƒåˆªé™¤æ‰€æœ‰æœƒå“¡ç›¸é—œè³‡æ–™
BEGIN;

DROP TABLE IF EXISTS feedback_events CASCADE;
DROP TABLE IF EXISTS conversation_sessions CASCADE;
DROP TABLE IF EXISTS place_favorites CASCADE;
DROP TABLE IF EXISTS trip_visits CASCADE;
DROP TABLE IF EXISTS trip_days CASCADE;
DROP TABLE IF EXISTS user_trips CASCADE;
DROP TABLE IF EXISTS user_preferences CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;

COMMIT;
```

## ğŸ“š ä¸‹ä¸€æ­¥

è³‡æ–™åº«è¨­å®šå®Œæˆå¾Œï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… é–‹å§‹å¯¦ä½œèªè­‰ API
   ```bash
   # å»ºç«‹èªè­‰æœå‹™
   mkdir -p src/itinerary_planner/application/services
   touch src/itinerary_planner/application/services/auth_service.py
   ```

2. âœ… å»ºç«‹è³‡æ–™åº« Repository
   ```bash
   # å»ºç«‹ä½¿ç”¨è€… Repository
   touch src/itinerary_planner/infrastructure/repositories/user_repository.py
   ```

3. âœ… ç·¨å¯« API ç«¯é»
   ```bash
   # å»ºç«‹èªè­‰ API
   touch src/itinerary_planner/api/v1/endpoints/auth.py
   ```

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: Migration åŸ·è¡Œå¤±æ•—æ€éº¼è¾¦ï¼Ÿ

```bash
# æª¢æŸ¥è³‡æ–™åº«é€£ç·š
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "SELECT version();"

# æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å·²å­˜åœ¨
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "\dt"

# å¦‚æœéœ€è¦é‡æ–°åŸ·è¡Œï¼Œå…ˆåˆªé™¤è¡¨æ ¼ï¼ˆåƒè€ƒ Rollback éƒ¨åˆ†ï¼‰
```

### Q2: ORM æ¨¡å‹è¼‰å…¥å¤±æ•—

```bash
# æª¢æŸ¥ Python è·¯å¾‘
python3 -c "import sys; print('\n'.join(sys.path))"

# é‡æ–°å®‰è£ä¾è³´
pip install -r requirements.txt
```

### Q3: å¤–éµç´„æŸéŒ¯èª¤

ç¢ºä¿ä¾ç…§é †åºæ’å…¥è³‡æ–™ï¼š
1. users â†’ user_preferences
2. places â†’ place_favorites
3. user_trips â†’ trip_days â†’ trip_visits

## ğŸ“ åƒè€ƒè³‡æ–™

- [ç³»çµ±æ¶æ§‹è¨­è¨ˆæ–‡ä»¶](./ç³»çµ±æ¶æ§‹è¨­è¨ˆæ–‡ä»¶.md)
- [Migration README](../scripts/migrations/README.md)
- [TODO æ¸…å–®](../TODO.md)
