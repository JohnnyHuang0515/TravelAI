# 🚀 智慧旅遊行程規劃系統 - 快速啟動指南

**更新日期**: 2025-09-30  
**系統版本**: v2.0 - 完整會員系統

---

## 📋 前置需求

- Python 3.10+
- PostgreSQL 14+（含 PostGIS）
- Redis 7+
- Docker & Docker Compose（推薦）

---

## ⚡ 快速啟動（5 分鐘）

### Step 1: 啟動基礎服務

```bash
# 啟動 PostgreSQL 和 Redis
docker-compose up -d db redis osrm
```

### Step 2: 安裝 Python 依賴

```bash
# 安裝依賴
pip install -r requirements.txt
```

### Step 3: 執行資料庫 Migration

```bash
# 建立會員系統資料表
python3 scripts/run_migration.py 001_create_user_system_tables
```

### Step 4: 啟動 API 服務

```bash
# 啟動服務器
python3 start_server.py
```

### Step 5: 測試系統

```bash
# 執行完整流程測試
python3 scripts/test_complete_flow.py
```

### Step 6: 查看 API 文件

訪問 http://localhost:8000/docs

---

## 📚 完整啟動步驟

### 1. 環境設定

```bash
# 設定環境變數
export DATABASE_URL="postgresql://postgres:password@localhost:5432/itinerary_db"
export REDIS_URL="redis://localhost:6379"
export OSRM_HOST="http://localhost:5000"
export JWT_SECRET="your-super-secret-key-min-32-characters"
export GEMINI_API_KEY="your-gemini-api-key"
```

### 2. 資料庫初始化

```bash
# 2.1 啟動 PostgreSQL
docker-compose up -d db

# 2.2 執行 Migration（建立會員系統表）
python3 scripts/run_migration.py 001_create_user_system_tables

# 2.3 驗證表格已建立
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "\dt"
```

### 3. 資料匯入（如需要）

```bash
# 3.1 匯入景點資料
python3 scripts/import_data.py

# 3.2 匯入住宿資料
python3 scripts/import_accommodation_data.py

# 3.3 生成向量 Embeddings（可選）
python3 scripts/generate_embeddings.py
```

### 4. OSRM 路網資料

```bash
# 4.1 處理 OSRM 資料（如果還沒處理）
bash process_osrm.sh

# 4.2 啟動 OSRM 服務
docker-compose up -d osrm
```

### 5. 啟動服務

```bash
# 啟動所有服務
docker-compose up -d

# 或只啟動後端 API
python3 start_server.py
```

---

## 🧪 測試 API

### 方法 1: 使用測試腳本

```bash
# 認證 API 測試
python3 scripts/test_auth_api.py

# 完整流程測試
python3 scripts/test_complete_flow.py
```

### 方法 2: 使用 Swagger UI

訪問 http://localhost:8000/docs

### 方法 3: 使用 curl

```bash
# 健康檢查
curl http://localhost:8000/health

# 註冊使用者
curl -X POST "http://localhost:8000/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testPass123",
    "username": "小明"
  }'

# 登入
curl -X POST "http://localhost:8000/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testPass123"
  }'

# 規劃行程
curl -X POST "http://localhost:8000/v1/itinerary/propose" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "test_session",
    "text": "我想去宜蘭玩兩天"
  }'
```

---

## 🎯 核心功能測試流程

### 完整使用者旅程

```
1. 註冊帳號
   ↓
2. 設定偏好（興趣、節奏、預算）
   ↓
3. 規劃行程（AI 自動套用偏好）
   ↓
4. 對話修改行程
   ↓
5. 儲存行程
   ↓
6. 分享行程給朋友
   ↓
7. 查看我的行程列表
   ↓
8. 附近景點推薦
   ↓
9. 收藏喜歡的景點
```

---

## 📊 API 端點總覽

### 🔐 認證 API（9個）
- POST /v1/auth/register
- POST /v1/auth/login
- POST /v1/auth/refresh
- POST /v1/auth/logout
- GET /v1/auth/me
- PUT /v1/auth/me
- POST /v1/auth/me/change-password
- GET /v1/auth/me/preferences
- PUT /v1/auth/me/preferences

### 📝 行程管理 API（8個）
- POST /v1/trips
- GET /v1/trips
- GET /v1/trips/{trip_id}
- PUT /v1/trips/{trip_id}
- DELETE /v1/trips/{trip_id}
- POST /v1/trips/{trip_id}/share
- GET /v1/trips/public/{share_token}
- POST /v1/trips/{trip_id}/copy

### 📍 景點推薦 API（4個）
- GET /v1/places/nearby
- GET /v1/places/favorites
- POST /v1/places/{place_id}/favorite
- DELETE /v1/places/{place_id}/favorite

### 🗺️ 行程規劃 API（2個）
- POST /v1/itinerary/propose ✨ 支援會員個性化
- POST /v1/itinerary/feedback

**總計: 23 個 API 端點**

---

## 🔧 環境變數設定

建立 `.env` 檔案：

```bash
# 複製範例檔案
cp .env.example .env

# 編輯設定
nano .env
```

必要設定：
- `DATABASE_URL` - PostgreSQL 連線字串
- `REDIS_URL` - Redis 連線字串
- `JWT_SECRET` - JWT 密鑰（至少 32 字元）
- `GEMINI_API_KEY` - Google Gemini API Key

---

## 🐛 常見問題

### Q1: 資料庫連線失敗

```bash
# 檢查 PostgreSQL 是否啟動
docker-compose ps db

# 檢查連線
psql postgresql://postgres:password@localhost:5432/itinerary_db -c "SELECT 1"
```

### Q2: OSRM 服務無法啟動

```bash
# 確認 OSRM 資料已處理
ls -lh data/osrm/taiwan*.osrm*

# 如果沒有，執行處理腳本
bash process_osrm.sh
```

### Q3: Redis 連線失敗

```bash
# 啟動 Redis
docker-compose up -d redis

# 測試連線
redis-cli ping
```

### Q4: Migration 失敗

```bash
# 檢查是否有衝突的表格
psql $DATABASE_URL -c "\dt"

# 如需重置，先 Rollback
psql $DATABASE_URL -f scripts/migrations/rollback_001.sql
```

---

## 📖 相關文件

- [系統架構設計文件](./系統架構設計文件.md)
- [認證 API 使用指南](./認證API使用指南.md)
- [快速開始-資料庫設定](./快速開始-資料庫設定.md)
- [會員系統整合完成](./會員系統整合完成.md)
- [TODO 清單](../TODO.md)

---

## 🎉 恭喜！

如果所有測試通過，您的智慧旅遊行程規劃系統後端已經完整運作！

下一步可以開始：
1. 前端專案設定
2. 設計使用者介面
3. 整合前後端

**Happy Coding! 🚀**
