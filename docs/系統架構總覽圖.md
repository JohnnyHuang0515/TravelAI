# 🏗️ 智慧旅遊行程規劃系統 - 架構總覽圖

**版本**: v2.0  
**更新日期**: 2025-09-30

---

## 📊 系統全景圖

```mermaid
graph TB
    subgraph "使用者端"
        Visitor[訪客]
        Member[會員]
    end
    
    subgraph "前端應用 (Phase 2)"
        Page1[頁面1: 基本資料輸入]
        Page2[頁面2: 行程生成與修改]
        Page3[頁面3: 附近景點推薦]
        Page4[頁面4: 我的行程]
        Auth[註冊/登入頁]
    end
    
    subgraph "API 層 (FastAPI)"
        AuthAPI[認證 API<br/>9個端點]
        TripAPI[行程管理 API<br/>8個端點]
        PlaceAPI[景點推薦 API<br/>4個端點]
        PlanAPI[行程規劃 API<br/>2個端點]
    end
    
    subgraph "應用服務層"
        AuthService[AuthService<br/>認證服務]
        TripService[TripService<br/>行程服務]
        PlanService[PlanningService<br/>規劃服務]
        ConvService[ConversationService<br/>對話服務]
    end
    
    subgraph "AI 引擎"
        LangGraph[LangGraph<br/>狀態機]
        Gemini[Gemini LLM<br/>對話理解]
        Retriever[混合檢索<br/>SQL+向量]
        Planner[貪婪規劃器<br/>+2-opt優化]
    end
    
    subgraph "資料存取層"
        UserRepo[UserRepository]
        TripRepo[TripRepository]
        PlaceRepo[PlaceRepository]
        FavRepo[FavoriteRepository]
    end
    
    subgraph "資料庫"
        PG[(PostgreSQL<br/>+PostGIS<br/>11張表)]
        Redis[(Redis<br/>快取+Session)]
    end
    
    subgraph "外部服務"
        OSRM[OSRM<br/>路網計算]
    end
    
    Visitor --> Page1
    Visitor --> Page3
    Member --> Auth
    Member --> Page1
    Member --> Page2
    Member --> Page3
    Member --> Page4
    
    Page1 --> PlanAPI
    Page2 --> PlanAPI
    Page2 --> TripAPI
    Page3 --> PlaceAPI
    Page4 --> TripAPI
    Auth --> AuthAPI
    
    AuthAPI --> AuthService
    TripAPI --> TripService
    PlaceAPI --> PlaceRepo
    PlanAPI --> PlanService
    PlanAPI --> ConvService
    
    AuthService --> UserRepo
    TripService --> TripRepo
    PlanService --> LangGraph
    ConvService --> LangGraph
    
    LangGraph --> Gemini
    LangGraph --> Retriever
    LangGraph --> Planner
    
    Planner --> OSRM
    
    UserRepo --> PG
    TripRepo --> PG
    PlaceRepo --> PG
    FavRepo --> PG
    Retriever --> PG
    LangGraph --> Redis
    OSRM --> Redis
    
    classDef user fill:#E3F2FD
    classDef frontend fill:#FFF9C4
    classDef api fill:#C8E6C9
    classDef service fill:#BBDEFB
    classDef ai fill:#F8BBD0
    classDef data fill:#FFE0B2
    classDef external fill:#D1C4E9
    
    class Visitor,Member user
    class Page1,Page2,Page3,Page4,Auth frontend
    class AuthAPI,TripAPI,PlaceAPI,PlanAPI api
    class AuthService,TripService,PlanService,ConvService service
    class LangGraph,Gemini,Retriever,Planner ai
    class UserRepo,TripRepo,PlaceRepo,FavRepo,PG,Redis data
    class OSRM external
```

---

## 🗄️ 資料庫架構圖

```mermaid
erDiagram
    USERS ||--|| USER_PREFERENCES : has
    USERS ||--o{ USER_TRIPS : owns
    USERS ||--o{ PLACE_FAVORITES : has
    USERS ||--o{ CONVERSATION_SESSIONS : creates
    
    USER_TRIPS ||--|{ TRIP_DAYS : contains
    USER_TRIPS ||--o{ FEEDBACK_EVENTS : receives
    
    TRIP_DAYS ||--|{ TRIP_VISITS : includes
    TRIP_DAYS }o--|| ACCOMMODATIONS : stays_at
    
    TRIP_VISITS }o--|| PLACES : visits
    
    PLACE_FAVORITES }o--|| PLACES : favorites
    
    PLACES ||--o{ HOURS : has
    
    USERS {
        uuid id PK
        string email UK "使用者 Email"
        string username "使用者名稱"
        string password_hash "密碼雜湊"
        string provider "認證提供者"
        timestamp created_at
    }
    
    USER_PREFERENCES {
        uuid id PK
        uuid user_id FK
        array favorite_themes "興趣主題"
        string travel_pace "旅遊節奏"
        string budget_level "預算等級"
        time default_daily_start "預設開始時間"
        time default_daily_end "預設結束時間"
    }
    
    USER_TRIPS {
        uuid id PK
        uuid user_id FK
        string title "行程標題"
        string destination "目的地"
        jsonb itinerary_data "完整行程JSON"
        boolean is_public "是否公開"
        string share_token "分享Token"
        int view_count "瀏覽次數"
    }
    
    TRIP_DAYS {
        uuid id PK
        uuid trip_id FK
        int day_number "第幾天"
        date date "日期"
        uuid accommodation_id FK
    }
    
    TRIP_VISITS {
        uuid id PK
        uuid trip_day_id FK
        uuid place_id FK
        int visit_order "訪問順序"
        time eta "到達時間"
        time etd "離開時間"
        int travel_minutes "交通時間"
    }
    
    PLACES {
        uuid id PK
        string name "景點名稱"
        geometry geom "地理座標"
        array categories "類別"
        int stay_minutes "停留時間"
        numeric rating "評分"
    }
    
    PLACE_FAVORITES {
        uuid id PK
        uuid user_id FK
        uuid place_id FK
        timestamp created_at
    }
```

---

## 🔄 使用者流程圖

### 流程 1: 行程規劃完整流程

```mermaid
flowchart TD
    Start([使用者開始]) --> Login{是否登入?}
    
    Login -->|否| Guest[訪客模式]
    Login -->|是| Member[會員模式]
    
    Guest --> Input1[填寫基本資料]
    Member --> AutoFill[自動填入偏好]
    AutoFill --> Input1
    
    Input1 --> Submit[提交規劃請求]
    Submit --> AI[AI 分析需求]
    
    AI --> Check{資訊完整?}
    Check -->|否| Question[AI 提問]
    Question --> Answer[使用者回答]
    Answer --> AI
    
    Check -->|是| Search[混合檢索景點]
    Search --> Plan[貪婪演算法規劃]
    Plan --> Optimize[2-opt 優化]
    Optimize --> Result[顯示行程結果]
    
    Result --> Satisfy{滿意?}
    Satisfy -->|否| Modify[對話修改]
    Modify --> AI
    
    Satisfy -->|是| IsMember{是會員?}
    IsMember -->|否| Download[下載行程]
    IsMember -->|是| Save[儲存到我的行程]
    
    Save --> End([完成])
    Download --> End
```

### 流程 2: 景點推薦流程

```mermaid
flowchart TD
    Start([使用者訪問附近景點]) --> GetLoc[取得地理位置]
    GetLoc --> Filter[設定篩選條件]
    Filter --> Search[PostGIS 半徑搜尋]
    Search --> Calc[計算距離]
    Calc --> Sort[距離排序]
    Sort --> Check{是會員?}
    
    Check -->|是| AddFav[標示收藏狀態]
    Check -->|否| ShowList[顯示景點列表]
    AddFav --> ShowList
    
    ShowList --> Action{使用者操作}
    Action -->|收藏| Favorite[加入收藏]
    Action -->|詳情| Detail[查看詳情]
    Action -->|加入行程| AddToTrip[加入規劃中行程]
    
    Favorite --> End([完成])
    Detail --> End
    AddToTrip --> End
```

### 流程 3: 會員行程管理

```mermaid
flowchart TD
    Start([會員登入]) --> Center[會員中心]
    Center --> View[查看行程列表]
    
    View --> Select{選擇操作}
    
    Select -->|查看| Detail[查看詳情]
    Select -->|編輯| Edit[編輯行程]
    Select -->|分享| Share[生成分享連結]
    Select -->|複製| Copy[複製為新行程]
    Select -->|刪除| Delete[刪除行程]
    
    Detail --> Map[地圖視覺化]
    
    Share --> Token[生成 Share Token]
    Token --> Public[設為公開]
    Public --> URL[返回分享 URL]
    
    Copy --> NewTrip[建立副本]
    NewTrip --> List[返回列表]
    
    Edit --> Save[儲存更新]
    Save --> List
    
    Delete --> Confirm{確認刪除?}
    Confirm -->|是| Remove[永久刪除]
    Confirm -->|否| List
    Remove --> List
    
    Map --> End([完成])
    URL --> End
    List --> End
```

---

## 🔑 關鍵技術整合圖

```mermaid
graph LR
    subgraph "認證層"
        JWT[JWT Token]
        BCrypt[BCrypt 加密]
    end
    
    subgraph "業務層"
        Auth[認證服務]
        Trip[行程服務]
        Plan[規劃服務]
    end
    
    subgraph "AI 層"
        LG[LangGraph]
        LLM[Gemini]
        Embed[Embeddings]
    end
    
    subgraph "資料層"
        ORM[SQLAlchemy ORM]
        PG[(PostgreSQL)]
        RD[(Redis)]
    end
    
    subgraph "地理層"
        PostGIS[PostGIS]
        OSRM[OSRM]
        Haversine[Haversine]
    end
    
    JWT --> Auth
    BCrypt --> Auth
    Auth --> ORM
    Trip --> ORM
    Plan --> LG
    LG --> LLM
    LG --> Embed
    ORM --> PG
    LG --> RD
    PostGIS --> PG
    OSRM --> RD
    Haversine --> PostGIS
```

---

## 📈 系統能力矩陣

| 功能模組 | 訪客 | 會員 | 技術實作 |
|---------|------|------|---------|
| **行程規劃** | ✅ 基本規劃 | ✅ 個性化規劃 | LangGraph + Gemini |
| **行程修改** | ✅ 即時修改 | ✅ 即時修改 | 對話式 DSL |
| **行程儲存** | ❌ | ✅ 儲存至帳號 | PostgreSQL |
| **行程分享** | ❌ | ✅ 生成公開連結 | Share Token |
| **查看公開行程** | ✅ | ✅ | Token 驗證 |
| **附近景點** | ✅ 基本推薦 | ✅ 顯示收藏狀態 | PostGIS + Haversine |
| **景點收藏** | ❌ | ✅ | 收藏表 |
| **個人設定** | ❌ | ✅ | 偏好表 |

---

## 🎯 資料流向圖

### 行程規劃資料流

```mermaid
sequenceDiagram
    participant U as 使用者
    participant F as 前端
    participant API as API Gateway
    participant Auth as 認證服務
    participant Plan as 規劃服務
    participant LG as LangGraph
    participant DB as 資料庫
    participant OSRM as OSRM
    
    U->>F: 輸入規劃需求
    F->>API: POST /itinerary/propose
    
    alt 會員登入
        API->>Auth: 驗證 Token
        Auth->>DB: 讀取偏好
        DB-->>Auth: 返回偏好
        Auth-->>API: 使用者+偏好
    end
    
    API->>Plan: 觸發規劃
    Plan->>LG: 初始化狀態
    
    LG->>LG: 對話管理
    LG->>DB: 檢索景點
    DB-->>LG: 候選景點
    
    LG->>OSRM: 計算交通時間
    OSRM-->>LG: 時間矩陣
    
    LG->>LG: 貪婪規劃
    LG->>LG: 2-opt 優化
    
    LG-->>API: 完整行程
    API-->>F: 返回行程 JSON
    F-->>U: 顯示行程
    
    alt 會員且滿意
        U->>F: 點擊儲存
        F->>API: POST /trips
        API->>DB: 儲存行程
        DB-->>API: 儲存成功
        API-->>F: 行程 ID
    end
```

---

## 🔐 認證流程圖

```mermaid
sequenceDiagram
    participant U as 使用者
    participant F as 前端
    participant API as API
    participant Auth as AuthService
    participant DB as Database
    
    rect rgb(200, 220, 240)
        Note over U,DB: 註冊流程
        U->>F: 輸入 Email + 密碼
        F->>API: POST /auth/register
        API->>Auth: register()
        Auth->>Auth: bcrypt 加密密碼
        Auth->>DB: 建立使用者
        Auth->>DB: 建立預設偏好
        Auth->>Auth: 生成 JWT Token
        Auth-->>API: User + Tokens
        API-->>F: 返回 Token
        F->>F: 儲存 Token
    end
    
    rect rgb(200, 240, 220)
        Note over U,DB: 登入流程
        U->>F: 輸入 Email + 密碼
        F->>API: POST /auth/login
        API->>Auth: login()
        Auth->>DB: 查詢使用者
        DB-->>Auth: User 資料
        Auth->>Auth: 驗證密碼
        Auth->>Auth: 生成 Token
        Auth->>DB: 更新最後登入時間
        Auth-->>API: User + Tokens
        API-->>F: 返回 Token
        F->>F: 儲存 Token
    end
    
    rect rgb(240, 220, 200)
        Note over U,DB: API 請求
        U->>F: 使用功能
        F->>API: Request + Bearer Token
        API->>Auth: 驗證 Token
        Auth->>Auth: JWT decode
        Auth->>DB: 查詢使用者
        DB-->>Auth: User 資料
        Auth-->>API: Current User
        API->>API: 執行業務邏輯
        API-->>F: 返回結果
    end
```

---

## 📊 技術棧視覺化

```mermaid
mindmap
  root((智慧旅遊<br/>行程規劃系統))
    後端
      FastAPI
        非同步 API
        自動文檔
        Pydantic 驗證
      SQLAlchemy
        ORM
        Migration
        關聯管理
      認證
        JWT
        bcrypt
        OAuth 2.0
    資料庫
      PostgreSQL
        關聯式資料
        ACID
      PostGIS
        地理查詢
        空間索引
      Redis
        Session
        快取
    AI 引擎
      LangGraph
        狀態機
        對話管理
      Gemini LLM
        自然語言理解
        回應生成
      混合檢索
        SQL 查詢
        向量搜尋
    規劃演算法
      貪婪演算法
        快速生成
        時間窗約束
      2-opt 優化
        局部優化
        路徑縮短
      OSRM
        路網計算
        交通時間
    前端(規劃中)
      React/Vue
        組件化
        響應式
      Tailwind CSS
        現代化 UI
      地圖整合
        Leaflet
        Google Maps
```

---

## 🎨 使用者介面概念圖

### 頁面 1: 基本資料輸入

```
┌────────────────────────────────────┐
│   🗺️ 開始規劃你的完美行程          │
├────────────────────────────────────┤
│                                    │
│  📍 目的地: [宜蘭         ▼]      │
│  📅 日期:   [2025-10-01   📅]     │
│  🕐 天數:   [2 天         ▼]      │
│                                    │
│  ❤️ 興趣 (多選):                  │
│  [✓] 美食  [✓] 自然  [ ] 文化    │
│  [ ] 親子  [ ] 購物  [ ] 夜生活  │
│                                    │
│  💰 預算: (●) 中等                │
│  ⏱️ 節奏: (●) 適中                │
│                                    │
│         [生成行程 →]               │
└────────────────────────────────────┘
```

### 頁面 2: 行程結果與修改

```
┌─────────────────┬──────────────────┐
│ 📅 第 1 天      │                  │
│                 │    [地圖顯示]    │
│ 09:00-11:00     │                  │
│ 🍜 羅東夜市     │      ●           │
│ ⭐ 4.5  🚗 15min│      │           │
│                 │      ● 景點路線  │
│ 11:15-13:00     │      │           │
│ 🌳 太平山       │      ●           │
│ ⭐ 4.8  🚗 40min│                  │
│                 │                  │
│ 🏨 宜蘭民宿     │                  │
├─────────────────┴──────────────────┤
│ 💬 修改行程:                       │
│ [輸入...] [送出]  [儲存行程 ⭐]   │
└────────────────────────────────────┘
```

---

## 📚 文件導航

### 🎯 快速開始
1. [快速啟動指南](快速啟動指南.md) - 5 分鐘啟動系統
2. [快速開始-資料庫設定](快速開始-資料庫設定.md) - 資料庫初始化

### 🏗️ 架構設計
1. [系統架構設計文件](系統架構設計文件.md) - 完整系統架構
2. [行程規劃邏輯文件](行程規劃邏輯文件.md) - AI 規劃邏輯

### 🔧 開發指南
1. [認證 API 使用指南](認證API使用指南.md) - API 使用說明
2. [Migration 指引](../scripts/migrations/README.md) - 資料庫 Migration

### 📊 進度報告
1. [TODO 清單](../TODO.md) - 開發待辦
2. [Phase 1 完成報告](../PHASE1_完成報告.md) - 階段性總結

---

**繪製日期**: 2025-09-30  
**下次更新**: Phase 2 前端開發開始
